<!doctype html><html lang=en class=no-js><head><script async src="https://www.googletagmanager.com/gtag/js?id=UA-36037335-10"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','UA-36037335-10')</script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.83.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" type=image/png href=/images/favicon.png><link rel=apple-touch-icon href=/favicons/apple-touch-icon-180x180.png sizes=180x180><link rel=manifest href=/manifest.webmanifest><link rel=apple-touch-icon href=/images/kubernetes-192x192.png><title>Graceful Node Shutdown Goes Beta | Kubernetes</title><meta property="og:title" content="Graceful Node Shutdown Goes Beta"><meta property="og:description" content="Authors: David Porter (Google), Mrunal Patel (Red Hat), and Tim Bannister (The Scale Factory)
Graceful node shutdown, beta in 1.21, enables kubelet to gracefully evict pods during a node shutdown.
Kubernetes is a distributed system and as such we need to be prepared for inevitable failures — nodes will fail, containers might crash or be restarted, and - ideally - your workloads will be able to withstand these catastrophic events."><meta property="og:type" content="article"><meta property="og:url" content="https://example.com/blog/2021/04/21/graceful-node-shutdown-beta/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2021-04-21T00:00:00+00:00"><meta property="article:modified_time" content="2021-05-27T14:04:42+01:00"><meta property="og:site_name" content="Kubernetes"><meta itemprop=name content="Graceful Node Shutdown Goes Beta"><meta itemprop=description content="Authors: David Porter (Google), Mrunal Patel (Red Hat), and Tim Bannister (The Scale Factory)
Graceful node shutdown, beta in 1.21, enables kubelet to gracefully evict pods during a node shutdown.
Kubernetes is a distributed system and as such we need to be prepared for inevitable failures — nodes will fail, containers might crash or be restarted, and - ideally - your workloads will be able to withstand these catastrophic events."><meta itemprop=datePublished content="2021-04-21T00:00:00+00:00"><meta itemprop=dateModified content="2021-05-27T14:04:42+01:00"><meta itemprop=wordCount content="1054"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="Graceful Node Shutdown Goes Beta"><meta name=twitter:description content="Authors: David Porter (Google), Mrunal Patel (Red Hat), and Tim Bannister (The Scale Factory)
Graceful node shutdown, beta in 1.21, enables kubelet to gracefully evict pods during a node shutdown.
Kubernetes is a distributed system and as such we need to be prepared for inevitable failures — nodes will fail, containers might crash or be restarted, and - ideally - your workloads will be able to withstand these catastrophic events."><link rel=preload href=/scss/main.min.7977f49df74ac0bb6ddcd5992b1805a268874812a2f606fd43a78d671d946193.css as=style><link href=/scss/main.min.7977f49df74ac0bb6ddcd5992b1805a268874812a2f606fd43a78d671d946193.css rel=stylesheet integrity><script src=/js/jquery-3.3.1.min.js integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin=anonymous></script><script type=application/ld+json>{"@context":"https://schema.org","@type":"Organization","url":"https://kubernetes.io","logo":"https://kubernetes.io/images/favicon.png","potentialAction":{"@type":"SearchAction","target":"https://example.com/search/?q={search_term_string}","query-input":"required name=search_term_string"}}</script><meta name=theme-color content="#326ce5"><link rel=stylesheet href=/css/feature-states.css><meta name=description content="Authors: David Porter (Google), Mrunal Patel (Red Hat), and Tim Bannister (The Scale Factory)
Graceful node shutdown, beta in 1.21, enables kubelet to gracefully evict pods during a node shutdown.
Kubernetes is a distributed system and as such we need to be prepared for inevitable failures — nodes will fail, containers might crash or be restarted, and - ideally - your workloads will be able to withstand these catastrophic events."><meta property="og:description" content="Authors: David Porter (Google), Mrunal Patel (Red Hat), and Tim Bannister (The Scale Factory)
Graceful node shutdown, beta in 1.21, enables kubelet to gracefully evict pods during a node shutdown.
Kubernetes is a distributed system and as such we need to be prepared for inevitable failures — nodes will fail, containers might crash or be restarted, and - ideally - your workloads will be able to withstand these catastrophic events."><meta name=twitter:description content="Authors: David Porter (Google), Mrunal Patel (Red Hat), and Tim Bannister (The Scale Factory)
Graceful node shutdown, beta in 1.21, enables kubelet to gracefully evict pods during a node shutdown.
Kubernetes is a distributed system and as such we need to be prepared for inevitable failures — nodes will fail, containers might crash or be restarted, and - ideally - your workloads will be able to withstand these catastrophic events."><meta property="og:url" content="https://example.com/blog/2021/04/21/graceful-node-shutdown-beta/"><meta property="og:title" content="Graceful Node Shutdown Goes Beta"><meta name=twitter:title content="Graceful Node Shutdown Goes Beta"><meta name=twitter:image content="https://kubernetes.io/images/favicon.png"><meta name=twitter:image:alt content="Kubernetes"><meta property="og:type" content="article"><script src=/js/script.js></script><title>Graceful Node Shutdown Goes Beta | Kubernetes</title><script defer src=https://use.fontawesome.com/releases/v5.0.6/js/all.js></script></head><body class="td-page td-blog"><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-row td-navbar" data-auto-burger=primary><a class=navbar-brand href=/></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"><li class="nav-item mr-2 mb-lg-0"><a class="nav-link active" href=/blog/>Team Blog</span></a></li><li class="nav-item mr-2 mb-lg-0"><a class=nav-link href=/community/>Community</span></a></li></ul></div><button id=hamburger onclick=kub.toggleMenu() data-auto-burger-exclude><div></div></button></nav><section class="header-hero text-center text-white font-bold pb-4"><h1>Team Blog</h1></section></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav pt-2 pl-4" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3"><li class=td-sidebar-nav__section-title><a href=/blog/2021/04/27/windows-workers/ class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__section">2021</a></li><ul><li class="blog-post collapse show" data-year=2021><a class="td-sidebar-link td-sidebar-link__page" id=m-blog-2021-04-27-windows-workers href=/blog/2021/04/27/windows-workers/>Windows workers with MicroK8s</a></li><li class="blog-post collapse show" data-year=2021><a class="td-sidebar-link td-sidebar-link__page active" id=m-blog-2021-04-21-graceful-node-shutdown-beta href=/blog/2021/04/21/graceful-node-shutdown-beta/>Graceful Node Shutdown Goes Beta</a></li><li class="blog-post collapse show" data-year=2021><a class="td-sidebar-link td-sidebar-link__page" id=m-blog-2021-03-09-the-evolution-of-kubernetes-dashboard href=/blog/2021/03/09/the-evolution-of-kubernetes-dashboard/>The Evolution of Kubernetes Dashboard</a></li><li class="more-posts collapse show" data-year=2021><a class=td-sidebar-link id=more-posts href>Show More Posts...</a></li></ul></ul></nav></div><script>let morePosts=document.querySelectorAll(".more-posts"),year="";morePosts.forEach(a=>{a.onclick=c=>{c.preventDefault(),year=a.dataset.year,console.log(year);let b=document.querySelectorAll(`.blog-post.hidden[data-year="${year}"]`);console.log(b),b.forEach(a=>{a.classList.add('show'),a.classList.remove("hidden")}),a.style.display="none"}})</script></div><main class="col-12 col-md-9 col-xl-8 pl-md-5 pr-md-4" role=main><div class=td-content><h1>Graceful Node Shutdown Goes Beta</h1><div class="td-byline mb-4"><time datetime=2021-04-21 class=text-muted>Wednesday, April 21, 2021</time></div><p><strong>Authors:</strong> David Porter (Google), Mrunal Patel (Red Hat), and Tim Bannister (The Scale Factory)</p><p>Graceful node shutdown, beta in 1.21, enables kubelet to gracefully evict pods during a node shutdown.</p><p>Kubernetes is a distributed system and as such we need to be prepared for inevitable failures — nodes will fail, containers might crash or be restarted, and - ideally - your workloads will be able to withstand these catastrophic events.</p><p>One of the common classes of issues are workload failures on node shutdown or restart. The best practice prior to bringing your node down is to <a href=/docs/tasks/administer-cluster/safely-drain-node/>safely drain and cordon your node</a>. This will ensure that all pods running on this node can safely be evicted. An eviction will ensure your pods can follow the expected <a href=/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination>pod termination lifecycle</a> meaning receiving a SIGTERM in your container and/or running <code>preStopHooks</code>.</p><p>Prior to Kubernetes 1.20 (when graceful node shutdown was introduced as an alpha feature), safe node draining was not easy: it required users to manually take action and drain the node beforehand. If someone or something shut down your node without draining it first, most likely your pods would not be safely evicted from your node and shutdown abruptly. Other services talking to those pods might see errors due to the pods exiting abruptly. Some examples of this situation may be caused by a reboot due to security patches or preemption of short lived cloud compute instances.</p><p>Kubernetes 1.21 brings graceful node shutdown to beta. Graceful node shutdown gives you more control over some of those unexpected shutdown situations. With graceful node shutdown, the kubelet is aware of underlying system shutdown events and can propagate these events to pods, ensuring containers can shut down as gracefully as possible. This gives the containers a chance to checkpoint their state or release back any resources they are holding.</p><p>Note, that for the best availability, even with graceful node shutdown, you should still design your deployments to be resilient to node failures.</p><h2 id=how-does-it-work>How does it work?</h2><p>On Linux, your system can shut down in many different situations. For example:</p><ul><li>A user or script running <code>shutdown -h now</code> or <code>systemctl poweroff</code> or <code>systemctl reboot</code>.</li><li>Physically pressing a power button on the machine.</li><li>Stopping a VM instance on a cloud provider, e.g. <code>gcloud compute instances stop</code> on GCP.</li><li>A Preemptible VM or Spot Instance that your cloud provider can terminate unexpectedly, but with a brief warning.</li></ul><p>Many of these situations can be unexpected and there is no guarantee that a cluster administrator drained the node prior to these events. With the graceful node shutdown feature, kubelet uses a systemd mechanism called <a href=https://www.freedesktop.org/wiki/Software/systemd/inhibit>"Inhibitor Locks"</a> to allow draining in most cases. Using Inhibitor Locks, kubelet instructs systemd to postpone system shutdown for a specified duration, giving a chance for the node to drain and evict pods on the system.</p><p>Kubelet makes use of this mechanism to ensure your pods will be terminated cleanly. When the kubelet starts, it acquires a systemd delay-type inhibitor lock. When the system is about to shut down, the kubelet can delay that shutdown for a configurable, short duration utilizing the delay-type inhibitor lock it acquired earlier. This gives your pods extra time to terminate. As a result, even during unexpected shutdowns, your application will receive a SIGTERM, <a href=/docs/concepts/containers/container-lifecycle-hooks/#container-hooks>preStop hooks</a> will execute, and kubelet will properly update <code>Ready</code> node condition and respective pod statuses to the api-server.</p><p>For example, on a node with graceful node shutdown enabled, you can see that the inhibitor lock is taken by the kubelet:</p><pre><code>kubelet-node ~ # systemd-inhibit --list
    Who: kubelet (UID 0/root, PID 1515/kubelet)
    What: shutdown
    Why: Kubelet needs time to handle node shutdown
    Mode: delay

1 inhibitors listed.
</code></pre><p>One important consideration we took when designing this feature is that not all pods are created equal. For example, some of the pods running on a node such as a logging related daemonset should stay running as long as possible to capture important logs during the shutdown itself. As a result, pods are split into two categories: "regular" and "critical". <a href=/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/#marking-pod-as-critical>Critical pods</a> are those that have <code>priorityClassName</code> set to <code>system-cluster-critical</code> or <code>system-node-critical</code>; all other pods are considered regular.</p><p>In our example, the logging DaemonSet would run as a critical pod. During the graceful node shutdown, regular pods are terminated first, followed by critical pods. As an example, this would allow a critical pod associated with a logging daemonset to continue functioning, and collecting logs during the termination of regular pods.</p><p>We will evaluate during the beta phase if we need more flexibility for different pod priority classes and add support if needed, please let us know if you have some scenarios in mind.</p><h2 id=how-do-i-use-it>How do I use it?</h2><p>Graceful node shutdown is controlled with the <code>GracefulNodeShutdown</code> <a href=/docs/reference/command-line-tools-reference/feature-gates>feature gate</a> and is enabled by default in Kubernetes 1.21.</p><p>You can configure the graceful node shutdown behavior using two kubelet configuration options: <code>ShutdownGracePeriod</code> and <code>ShutdownGracePeriodCriticalPods</code>. To configure these options, you edit the kubelet configuration file that is passed to kubelet via the <code>--config</code> flag; for more details, refer to <a href=/docs/tasks/administer-cluster/kubelet-config-file/>Set kubelet parameters via a configuration file</a>.</p><p>During a shutdown, kubelet terminates pods in two phases. You can configure how long each of these phases lasts.</p><ol><li>Terminate regular pods running on the node.</li><li>Terminate critical pods running on the node.</li></ol><p>The settings that control the duration of shutdown are:</p><ul><li><code>ShutdownGracePeriod</code><ul><li>Specifies the total duration that the node should delay the shutdown by. This is the total grace period for pod termination for both regular and critical pods.</li></ul></li><li><code>ShutdownGracePeriodCriticalPods</code><ul><li>Specifies the duration used to terminate critical pods during a node shutdown. This should be less than <code>ShutdownGracePeriod</code>.</li></ul></li></ul><p>For example, if <code>ShutdownGracePeriod=30s</code>, and <code>ShutdownGracePeriodCriticalPods=10s</code>, kubelet will delay the node shutdown by 30 seconds. During this time, the first 20 seconds (30-10) would be reserved for gracefully terminating normal pods, and the last 10 seconds would be reserved for terminating critical pods.</p><p>Note that by default, both configuration options described above, <code>ShutdownGracePeriod</code> and <code>ShutdownGracePeriodCriticalPods</code> are set to zero, so you will need to configure them as appropriate for your environment to activate graceful node shutdown functionality.</p><h2 id=how-can-i-learn-more>How can I learn more?</h2><ul><li>Read the <a href=/docs/concepts/architecture/nodes/#graceful-node-shutdown>documentation</a></li><li>Read the enhancement proposal, <a href=https://github.com/kubernetes/enhancements/tree/master/keps/sig-node/2000-graceful-node-shutdown>KEP 2000</a></li><li>View the <a href=https://github.com/kubernetes/kubernetes/tree/release-1.21/pkg/kubelet/nodeshutdown>code</a></li></ul><h2 id=how-do-i-get-involved>How do I get involved?</h2><p>Your feedback is always welcome! SIG Node meets regularly and can be reached via <a href=https://slack.k8s.io>Slack</a> (channel <code>#sig-node</code>), or the SIG's <a href=https://github.com/kubernetes/community/tree/master/sig-node#contact>mailing list</a></p><ul class="list-unstyled d-flex justify-content-between align-items-center mb-0 pt-5"><li><a href=/blog/2021/03/09/the-evolution-of-kubernetes-dashboard/ class="btn btn-primary"><span class=mr-1>←</span> Previous</a></li><a href=/blog/2021/04/27/windows-workers/ class="btn btn-primary">Next <span class=ml-1>→</span></a></li></ul></div></main><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-blog-meta ml-2 pb-1 pt-2 mb-4"><link rel=alternate type=application/rss+xml href=https://example.com/feed.xml title=Kubernetes><a class=widget-link href=https://example.com/feed.xml><div><i class="fas fa-rss fab-icon"></i><span class=widget-link-text>RSS Feed</span></div></a><a class=widget-link href=https://twitter.com/kubernetesio><div><i class="fab fa-twitter-square fab-icon"></i><span class=widget-link-text>@Kubernetesio</span></div></a><a class=widget-link href=https://github.com/kubernetes/kubernetes><div><i class="fab fa-github-square fab-icon"></i> <span class=widget-link-text>on GitHub</span></div></a><a class=widget-link href=http://slack.k8s.io><div><i class="fab fa-slack fab-icon"></i><span class=widget-link-text>#kubernetes-users</span></div></a><a class=widget-link href=https://stackoverflow.com/questions/tagged/kubernetes><div><i class="fab fa-stack-overflow fab-icon"></i> <span class=widget-link-text>Overflow</span></div></a><a class=widget-link href=https://discuss.kubernetes.io><div><i class="fab fa-discourse fab-icon"></i><span class=widget-link-text> Forum</span></div></a><a class=widget-link href=https://kubernetes.io/docs/setup><div><i class="fa fa-download fab-icon"></i> <span class=widget-link-text>Kubernetes</span></div></a></div></div></div></div><footer class=d-print-none><div class=footer__links><nav><a class=text-white href=/blog/>Blog</a>
<a class=text-white href=/community/>Community</a></nav></div><div class=container-fluid><div class=row><div class="col-6 col-sm-2 text-xs-center order-sm-2"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Twitter aria-label=Twitter><a class=text-white target=_blank href=https://twitter.com/ubuntu><i class="fab fa-twitter"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Youtube aria-label=Youtube><a class=text-white target=_blank href=https://youtube.com/kubernetescommunity><i class="fab fa-youtube"></i></a></li></ul></div><div class="col-6 col-sm-2 text-right text-xs-center order-sm-3"><ul class="list-inline mb-0"><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=GitHub aria-label=GitHub><a class=text-white target=_blank href=https://github.com/kubernetes/kubernetes><i class="fab fa-github"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Slack aria-label=Slack><a class=text-white target=_blank href=https://slack.k8s.io><i class="fab fa-slack"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title=Contribute aria-label=Contribute><a class=text-white target=_blank href=https://git.k8s.io/community/contributors/guide><i class="fas fa-edit"></i></a></li><li class="list-inline-item mx-2 h3" data-toggle=tooltip data-placement=top title="Stack Overflow" aria-label="Stack Overflow"><a class=text-white target=_blank href=https://stackoverflow.com/questions/tagged/kubernetes><i class="fab fa-stack-overflow"></i></a></li></ul></div><div class="col-12 col-sm-8 text-center order-sm-2"><br><small class=text-white>Copyright &copy; 2021 The Linux Foundation &reg;. All rights reserved. The Linux Foundation has registered trademarks and uses trademarks. For a list of trademarks of The Linux Foundation, please see our <a href=https://www.linuxfoundation.org/trademark-usage class=light-text>Trademark Usage page</a></small><br><small class=text-white>ICP license: 京ICP备17074266号-3</small></div></div></div></footer></div><script src=/js/popper-1.14.3.min.js integrity=sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49 crossorigin=anonymous></script><script src=/js/bootstrap-4.3.1.min.js integrity=sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM crossorigin=anonymous></script><script src=/js/main.min.631e695cd1b79b859f7c95801f5bb473ea0d4e829e3eb2a573281e7f0d67bf4c.js integrity="sha256-Yx5pXNG3m4WffJWAH1u0c+oNToKePrKlcygefw1nv0w=" crossorigin=anonymous></script></body></html>